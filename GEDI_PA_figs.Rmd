---
title: "GEDI PA Figures"
output: html_notebook
---

This notebook produces the figures for the Paper 'Global protected areas are effective for preserving forest structure and carbon'.

Fig 1: Methods flowchart
```{r}
#Created Externally by V Leitold
```

Fig 2: Global GEDI height, RH50, cover & biomass
```{r}
#Placeholder exists, but we will create our own version with the final data used 
gfs=list.files(paste(f.path,"/WDPA_gedi_l2a+l2b_clean/", iso3, sep=""), full.names = TRUE)  #grab all files from l2ab clean for gfs to run globally 
bbox=matrix(c(-179.9,-52,179.9,83), nrow = 2, dimnames = list(c("x","y"), c("min", "max")))  #get a worldwide bbox to run globally 
bc_big <- get_map(location = bbox, source="stamen", maptype="terrain", crop=FALSE)
b=c(seq(0,50,10),60)
lab=format(b)
lab[length(b)]="50+"
lab

mbase=ggmap(bc_big) + 
  scale_color_gradientn(limits = c(0,200),
                        colours=c("olivedrab1",
                                  "olivedrab4", "darkgreen","midnightblue", "red4"),
                        breaks=b, labels=lab,name=paste("Max Canopy Height, n=", nrow(data))) +
  theme(legend.text = element_text(color = "black", size = 8),
        rect = element_rect(fill = "transparent"))

for (f in gfs){
  print(f)
  dsub=read.csv(f) %>% dplyr::select(lon_lowestmode, lat_lowestmode, rh_098)
  mbase=mbase+ geom_point(data = dsub, mapping = aes(x = lon_lowestmode, y = lat_lowestmode,color = rh_098), size=0.3, alpha=0.3)
  
}

mall=mbase+geom_polygon(data =adm,size=0.5,
                   aes(long, lat, group = group),
                   colour = "black", alpha = 0)+
  geom_polygon(data =allPAs,size=0.15,
               aes(long, lat, group = group),
               colour = "red", alpha = 0)+
  labs(title = "GEDI data over Tanzania color coded by max height metrics", 
       subtitle="Polygon overlay: all PAs")

ggplot2::ggsave(filename="/gpfs/data1/duncansongp/amberliang/trends.Earth/TZA_result/rhmap.png", plot=mapall, width=8, height=6,
                units = "in", bg = "transparent")

```

Fig 3: Global PAs for paper
```{r}
#Created externally by V Leitold
```

Fig 4: Number of GEDI shots per 1 km pixel
```{r}
#Coded  by M Liang
#GEDI shots distribution per 1km cell  Figure 4a
fpath <- "/gpfs/data1/duncansongp/GEDI_global_PA/WDPA_GEDI_extract3/cell_stats"
dir(fpath)

shotInCell <- data.frame()
shotf=list.files(fpath, pattern="cell_shots", full.names = TRUE)
# vars=c("x","y","gshot","status","pid","iso3")

for (d in shotf){
  print(d)
  cout <- read.csv(d)
  cout <- cout[!is.na(cout$pid),] 
  iso3 <- cout$country %>% unique() %>% na.omit()
  print(iso3)
  tmp <-  data.frame(iso3=cout$country, status=as.factor(cout$status), gshot=cout$gshot_counts, stringsAsFactors=F)
  shotInCell <- shotInCell %>% rbind(tmp, stringsAsFactors=F)
}

print(dim(shotInCell))

# plot
p <- shotInCell %>%
  ggplot( aes(x=gshot)) +
  geom_histogram( binwidth=1, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  labs(title = "GEDI shots in each matched 1km cell",subtitle = paste("Binwidth = 1; n =", format(nrow(shotInCell), big.mark=","), "iso3 =", length(unique(shotInCell$iso3)), sep=" ")) +
  theme_ipsum() +
  theme(
    plot.title = element_text(size=15)
  )+
  labs(x = "Number of GEDI shots in 1km Pixel")
p

#GEDI shots distribution per pa  Figure 4b

fpath <- "/gpfs/data1/duncansongp/GEDI_global_PA/WDPA_GEDI_extract3/pa_stats"
dir(fpath)

shotInPA <- data.frame()
shotpaf=list.files(fpath, pattern="pa_stats_summary", full.names = TRUE)

for (d in shotpaf){
  print(d)
  cout <- read.csv(d,header = TRUE)
  cout <- cout[!is.na(cout$pa_id),] 
  iso3 <- cout$iso3 %>% unique() %>% na.omit()
  print(iso3)
  tmp <-  data.frame(iso3=cout$iso3,pid=cout$pa_id, gshot=cout$count_1, stringsAsFactors=F)
  shotInPA <- shotInPA %>% rbind(tmp, stringsAsFactors=F)

}  
print(dim(shotInPA))
# plot
p2 <- shotInPA %>%
  ggplot( aes(x=gshot)) +
  geom_histogram( binwidth=500, fill="#FA8072", color="#FA8072", alpha=0.6) +
  labs(title = "GEDI shots in each matched PA",subtitle = paste("Binwidth = 500; ","n =", format(nrow(shotInPA), big.mark=","), "; iso3 =", length(unique(shotInPA$iso3)), sep=" ")) +
  theme_ipsum() +
  theme(
    plot.title = element_text(size=15)
  )+
  labs(x = "Number of GEDI shots in each PA")
p2
```

Fig 5: Comparison of four metrics for globe
```{r}

fpath <- "/gpfs/data1/duncansongp/GEDI_global_PA/WDPA_GEDI_extract3/iso_full_nodup"
dir(fpath)

#check biomass distribution
sub <- data.frame()
dd <- list.files(path = fpath, full.names = TRUE, recursive=FALSE)

for (d in dd){
  # df <- list.files(d, pattern = ".RDS", full.names = TRUE)
  # print(length(df))
  # for (f in df){
    
    tmp <- read.csv(d) %>% 
      dplyr::filter(!is.na(pa_id)) %>% 
      dplyr::select(status, rh_098, AGBD, cover, pai)
    sub <- sub %>% rbind(tmp, stringsAsFactors=FALSE)
    print(dim(sub))
  
}
sub%>%
  filter(!is.na(status)) %>% 
  mutate(pa_stat=factor(status)) %>% 
  dplyr::select(pa_stat, rh_098,cover,pai, AGBD)%>%
  gather(GEDI_metrics, values, rh_098,cover,pai, AGBD)%>%
  mutate(values=round(values,2))->metric_sub
dim(metric_sub)
metric_sub$GEDI_metrics=factor(metric_sub$GEDI_metrics,levels=c("rh_098","cover","pai", "AGBD"),
                               labels = c("Max Canopy Height", 
                                          "Plant Area Index (PAI)", "Canopy Cover","Aboveground Biomass Density (AGBD)"))
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}
p <- ggplot(metric_sub, aes(GEDI_metrics, values, fill=pa_stat))
t=table(metric_sub$pa_stat)  #total metrics for each dist_bin; for legend
t=t[t!=0]
names(t)=c("control","Protected/treated")
metric_sub$GEDI_metrics%>%unique()%>%length()->n  #how many metrics used
#source in the custome panel plot scaling script
source("/gpfs/data1/duncansongp/amberliang/scripts/individule_facet_scale.R")
p2=p + geom_violin(position = position_dodge(1),width=0.8, trim=T,na.rm=F) + 
  facet_wrap(~GEDI_metrics, scale="free",ncol=2)+
  scale_fill_manual(name = "Protected vs. Controls", 
                    labels = c(paste(names(t), "n=", format(t/n, big.mark=","),sep=" ")),
                    values =c("#ebac3f","#f7e874"))+
  labs(title = "GEDI metrics and AGBD for Moyowosi Game Reserve vs. controls",subtitle = "Stats overlay: median and IQR (red), mean (blue), mode (green)")+
  stat_summary(
    fun.ymin = function(z) { quantile(z,0.25) },
    fun.ymax = function(z) { quantile(z,0.75) },
    fun.y = median,
    size=0.3, width=0.3,
    geom = "pointrange", color="#e41a1c",position = position_dodge(1))+
  stat_summary(
    fun.y =  function(z) {mean(z, na.rm=T)},
    size=1.5, 
    geom="point", color="#377eb8",shape=17,position = position_dodge(1))+
  stat_summary(
    fun.y =  function(z) {getmode(z)},
    size=1.5,
    geom="point", color="#4daf4a",shape=15, position = position_dodge(1))+
  facet_wrap_custom(~GEDI_metrics, scales = "free", ncol = 2, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0,45))),
    scale_override(2, scale_y_continuous(limits = c(0,1))),
    scale_override(3, scale_y_continuous(limits = c(0,3))),
    scale_override(4, scale_y_continuous(limits = c(0,200)))))

ggplot2::ggsave(filename="/gpfs/data1/duncansongp/GEDI_global_PA/fig5.png", plot=p2, width=10, height=12,
                units = "in", bg = "transparent")

ps=sub %>% dplyr::select(status, AGBD) %>% mutate(status=as.factor(status))
psp=ggplot(data=ps, aes(x=AGBD, group=status, fill=status)) +
  geom_density(adjust=1.5,  alpha=.4) +
  theme_ipsum() 
ggplot2::ggsave(filename="/gpfs/data1/duncansongp/GEDI_global_PA/fig5b.png", plot=p2, width=10, height=12,
                units = "in", bg = "transparent")

```

Fig 6: Comparison of four metrics for globe, divided by continent
```{r}

```

Fig 7: Comparison of four metrics for the top 10 countries with most PAs (or similar)
```{r}

```

Fig 8: Comparison of four metrics for different biome classes
```{r}

```

Fig 9: Country-level PA distribution figure (e.g. Brazil)
```{r}
#Created externally by V Leitold
```

Fig 10: Relative importance of variables to determine biomass preservation efficacy 
```{r}

```




